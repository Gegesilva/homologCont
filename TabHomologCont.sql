CREATE TABLE HOMOLOG_CONTAINER (
	NCONTAINER VARCHAR(50),
	DTCAD DATETIME,
	NUMSERIE VARCHAR(50),
	MODELO1 VARCHAR(50),
	MODELO2 VARCHAR(50),
	TIPOALT VARCHAR(10),
	GRAVACÃO VARCHAR(10),
	TIPO VARCHAR(10),
	VEND_COMP VARCHAR(10)
)

SELECT * FROM HOMOLOG_CONTAINER

INSERT INTO HOMOLOG_CONTAINER
(
	NCONTAINER,
	DTCAD,
	NUMSERIE,
	MODELO1,
	MODELO2,
	TIPOALT,
	GRAVACÃO,
	TIPO,
	VEND_COMP
)SELECT TOP 1
	':container',
	GETDATE(),
	TB02054_NUMSERIE,
	TB02054_PRODUTO,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL
	FROM TB02054
	WHERE TB02054_NUMSERIE = 'A9JU011000514'


	SELECT * FROM TB02054 WHERE TB02054_NUMSERIE = 'A9JU011000514'









SELECT
	TB02055_NUMSERIE Serie,
	TB02002_NCONTEINER Container,
	TB01010_REFERENCIA Modelo
FROM TB02002
LEFT JOIN TB02003 ON TB02003_CODIGO = TB02002_CODIGO
LEFT JOIN TB02055 ON TB02055_CODIGO = TB02002_CODIGO 
	AND TB02055_PRODUTO = TB02003_PRODUTO 
	AND TB02055_TABELA = 'TB02002'
LEFT JOIN TB01010 ON TB01010_CODIGO = TB02003_PRODUTO
WHERE TB02002_NCONTEINER = 'C2025.07'








-- lista dos numeros de serie homologados
WITH HOMOLOG AS (
    SELECT DISTINCT NUMSERIE, MODELO1 FROM HOMOLOG_CONTAINER
),

-- numeros de serie da compra
COMPRA AS (
    SELECT DISTINCT 
        TB02055_NUMSERIE AS Serie, 
        TB02055_CODIGO,
        TB02003_PRODUTO AS Modelo,
        TB01010_REFERENCIA Referencia,
        TB02002_NCONTEINER AS Container
    FROM TB02002
    JOIN TB02003 ON TB02003_CODIGO = TB02002_CODIGO
    JOIN TB02055 ON TB02055_CODIGO = TB02002_CODIGO
        AND TB02055_PRODUTO = TB02003_PRODUTO
        AND TB02055_TABELA = 'TB02002'
    LEFT JOIN TB01010 ON TB01010_CODIGO = TB02003_PRODUTO
    WHERE TB02002_NCONTEINER = 'C2025.04'
),

-- BipExist: flag por serie
BIP_EXIST AS (
    SELECT DISTINCT 
        c.Serie,
        1 AS BipExist
    FROM COMPRA c
    JOIN HOMOLOG h ON c.Serie = h.NUMSERIE
),

-- BipNotExist: flag por modelo
BIP_NOT_EXIST AS (
    SELECT DISTINCT 
        c.Modelo,
        1 AS BipNotExist
    FROM COMPRA c
    JOIN HOMOLOG h 
        ON c.Modelo = h.MODELO1
    WHERE NOT EXISTS (
        SELECT 1 
        FROM TB02055 t
        JOIN TB02003 i ON i.TB02003_PRODUTO = t.TB02055_PRODUTO
        WHERE t.TB02055_CODIGO = c.TB02055_CODIGO
          AND t.TB02055_NUMSERIE = h.NUMSERIE
          AND t.TB02055_PRODUTO = i.TB02003_PRODUTO
    )
)

-- resultado final
SELECT DISTINCT
    c.Serie,
    c.Container,
    c.Modelo,
	c.Referencia,
    ISNULL(be.BipExist, 0) AS BipExist,
    ISNULL(bne.BipNotExist, 0) AS BipNotExist
FROM COMPRA c
LEFT JOIN BIP_EXIST be ON be.Serie = c.Serie
LEFT JOIN BIP_NOT_EXIST bne ON bne.Modelo = c.Modelo
ORDER BY c.Serie
